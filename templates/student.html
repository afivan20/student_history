<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{name}}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <link id="favicon" rel="icon" type="image/x-icon" href="/static/favicon.png">
    <style>
        :root {
            color-scheme: light;
            --bg-color: #ffffff;
            --text-color: rgba(0, 0, 0, 0.87);
            --secondary-bg: #f9f9f9;
            --segment-bg: #ffffff;
            --unpaid-bg: #F4C3C3;
            --paid-bg: #AEFCBA;
            --border-color: rgba(34, 36, 38, 0.15);
        }

        body {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }

        .ui.segment {
            background-color: var(--segment-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .ui.header {
            color: var(--text-color);
        }

        .ui.container {
            margin-top: 50px;
        }

        .student-switcher {
            margin-bottom: 20px;
        }

        .student-switcher .ui.buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .student-switcher .ui.button {
            margin: 0 !important;
        }

        .student-switcher .ui.button.active {
            background-color: #2185d0 !important;
            color: white !important;
        }
    </style>
</head>

<body>
    <div class="ui container">
        <h1 class="ui center aligned header">{{name}}</h1>

        {% if linked_students %}
        <div class="student-switcher">
            <div class="ui buttons">
                {% for s in linked_students %}
                <a class="ui button {% if s.slug == student_id %}active{% endif %}"
                   href="/student?query={{query}}{% if token %}&token={{token}}{% endif %}"
                   onclick="switchStudent('{{ s.slug }}'); return false;">
                    {{ s.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <h2 id="balance-message" class="ui center aligned header">{{message}}</h2>
        <hr>
    </div>

    <div class="ui container">
        {% for lesson in history %}
        <div class="ui segment"{% if 'Оплата' in lesson %} style="background-color: var(--paid-bg);"{% endif %}>
            <p class="ui big center aligned header">{{lesson }}</p>          
        </div>
        {% endfor %}
        {%if is_more%}
        <center>
            <a class="ui blue button" href="/student?query={{query+5}}{% if token %}&token={{token}}{% endif %}">Ещё</a>
        </center>
        {%endif%}
    </div>

    <script>
        // Определение темной темы
        function isColorDark(hexColor) {
            if (!hexColor || hexColor.length < 7) return false;
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance < 0.5;
        }

        // Настройка Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            const theme = tg.themeParams;
            const root = document.documentElement;

            // Применить CSS переменные из темы Telegram
            if (theme.bg_color) {
                root.style.setProperty('--bg-color', theme.bg_color);
            }
            if (theme.text_color) {
                root.style.setProperty('--text-color', theme.text_color);
            }
            if (theme.secondary_bg_color) {
                root.style.setProperty('--secondary-bg', theme.secondary_bg_color);
                root.style.setProperty('--segment-bg', theme.secondary_bg_color);
            }
            if (theme.hint_color) {
                root.style.setProperty('--border-color', theme.hint_color);
            }

            // Для темной темы адаптировать цвета статусов
            const isDark = theme.bg_color && isColorDark(theme.bg_color);
            if (isDark) {
                root.style.setProperty('--unpaid-bg', '#8B4444');
                root.style.setProperty('--paid-bg', '#3D7A4A');
            }
        }

        // Динамическая загрузка баланса с retry
        async function loadBalance() {
            const balanceEl = document.getElementById('balance-message');
            const maxRetries = 5;
            const baseDelay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const token = new URLSearchParams(window.location.search).get('token') || '';
                    const url = `/api/student/balance${token ? '?token=' + token : ''}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.status === 'ok') {
                        const message = data.balance >= 0
                            ? `Доступно уроков: ${data.balance}`
                            : `Неоплаченных уроков: ${Math.abs(data.balance)}`;
                        balanceEl.textContent = message;
                        balanceEl.style.backgroundColor = data.balance < 0
                            ? 'var(--unpaid-bg)' : '';
                        return;
                    }

                    if (data.status === 'error') {
                        balanceEl.textContent = 'Ошибка загрузки баланса';
                        return;
                    }

                    // status === 'loading' - формула ещё не вычислилась
                    if (attempt < maxRetries - 1) {
                        balanceEl.textContent = `Загрузка данных... (попытка ${attempt + 2})`;
                        await new Promise(r => setTimeout(r, baseDelay * (attempt + 1)));
                    }
                } catch (error) {
                    console.error('Ошибка загрузки баланса:', error);
                    if (attempt === maxRetries - 1) {
                        balanceEl.textContent = 'Не удалось загрузить баланс';
                    }
                }
            }

            balanceEl.textContent = 'Не удалось загрузить баланс. Обновите страницу.';
        }

        document.addEventListener('DOMContentLoaded', loadBalance);

        // Получить telegram_id из initData (для Desktop Telegram где initData может быть пустой)
        function getTelegramId() {
            const initData = window.Telegram?.WebApp?.initData;
            if (initData) {
                try {
                    const params = new URLSearchParams(initData);
                    const userJson = params.get('user');
                    if (userJson) {
                        const user = JSON.parse(userJson);
                        return user.id?.toString();
                    }
                } catch (e) {
                    console.error('Error parsing initData:', e);
                }
            }
            return null;
        }

        // Переключение между студентами
        let isSwitching = false;

        async function switchStudent(studentSlug) {
            // Если это текущий студент - ничего не делаем
            if (studentSlug === '{{ student_id }}') return;

            // Debouncing - предотвратить параллельные запросы
            if (isSwitching) return;
            isSwitching = true;

            const buttons = document.querySelectorAll('.student-switcher .button');
            buttons.forEach(btn => btn.classList.add('loading'));

            try {
                const response = await fetch('/auth/select-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': window.Telegram?.WebApp?.initData || '',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        student_slug: studentSlug,
                        telegram_id: getTelegramId()
                    }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success && data.redirect_url) {
                    // Cookie selected_student_id установлена, перезагружаем страницу
                    window.location.href = `${data.redirect_url}?query={{ query }}`;
                } else {
                    alert(data.error || 'Ошибка переключения');
                    buttons.forEach(btn => btn.classList.remove('loading'));
                    isSwitching = false;
                }
            } catch (error) {
                console.error('Switch error:', error);
                alert('Ошибка соединения');
                buttons.forEach(btn => btn.classList.remove('loading'));
                isSwitching = false;
            }
        }
    </script>
</body>
</html>